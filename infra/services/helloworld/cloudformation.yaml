Parameters:
  DomainName:
    Description: Domain Name
    Type: String

  HostedZoneName:
    Description: Hosted Zone Name
    Type: String

  ClusterSize:
    Description: Number of EC2 instances in the cluster
    Type: Number
    Default: 4

  InstanceType:
    Description: Instance type for EC2 instances in the cluster
    Type: String
    Default: t3.nano

  ContainerImage:
    Description: Container image url
    Type: String
    Default: image:latest

  ContainerPort:
    Description: Port that the container exposes
    Type: Number
    Default: 80

Resources:
  Cluster:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ../../modules/main.yaml
      Parameters:
        DomainName: !Ref DomainName
        HostedZoneName: !Ref HostedZoneName
        ClusterSize: !Ref ClusterSize
        InstanceType: !Ref InstanceType

  HelloWorldService:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ../../modules/service.yaml
      Parameters:
        ContainerName: helloworld
        ContainerImage: !Ref ContainerImage
        ContainerPort: !Ref ContainerPort
        VPC: !GetAtt Cluster.Outputs.VPC
        Cluster: !GetAtt Cluster.Outputs.Cluster
        DesiredCount: 2
        HTTPSListener: !GetAtt Cluster.Outputs.HTTPSListener
        HTTPListener: !GetAtt Cluster.Outputs.HTTPListener
        Path: /
        ECSServiceAutoScalingRoleARN: !GetAtt Cluster.Outputs.AutoScalingRole

Outputs:
  Url:
    Description: The URL endpoint for the helloworld service
    Value: !GetAtt Cluster.Outputs.Url
